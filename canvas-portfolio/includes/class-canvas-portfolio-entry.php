<?php
/**
 * The Class Portfolio Entry
 *
 * @link       https://codesupply.co
 * @since      1.0.0
 *
 * @package    CNVSPort
 * @subpackage CNVSPort/includes
 */

if ( ! class_exists( 'CNVSPort_Entry' ) ) {
	/**
	 * Create Class Portfolio Entry
	 */
	class CNVSPort_Entry {
		/**
		 * The attributes.
		 *
		 * @var string $attributes The attributes.
		 */
		public $attributes = null;

		/**
		 * The options.
		 *
		 * @var string $options The options.
		 */
		public $options = null;

		/**
		 * The source.
		 *
		 * @var string $source The source.
		 */
		public $source = null;

		/**
		 * The object_id.
		 *
		 * @var string $object_id The object_id.
		 */
		public $object_id = null;

		/**
		 * The obgect_link.
		 *
		 * @var string $obgect_link The obgect_link.
		 */
		public $obgect_link = null;

		/**
		 * The attachment_id.
		 *
		 * @var string $attachment_id The attachment_id.
		 */
		public $attachment_id = null;

		/**
		 * The attachment_link.
		 *
		 * @var string $attachment_link The attachment_link.
		 */
		public $attachment_link = null;

		/**
		 * The attachment_link_to.
		 *
		 * @var string $attachment_link_to The attachment_link_to.
		 */
		public $attachment_link_to = null;

		/**
		 * The attachment_full_link.
		 *
		 * @var string $attachment_full_link The attachment_full_link.
		 */
		public $attachment_full_link = null;

		/**
		 * The attachment_html.
		 *
		 * @var string $attachment_html The attachment_html.
		 */
		public $attachment_html = null;

		/**
		 * The attachment_title.
		 *
		 * @var string $attachment_title The attachment_title.
		 */
		public $attachment_title = null;

		/**
		 * The attachment_title_tag.
		 *
		 * @var string $attachment_title_tag The attachment_title_tag.
		 */
		public $attachment_title_tag = 'h3';

		/**
		 * The attachment_meta.
		 *
		 * @var string $attachment_meta The attachment_meta.
		 */
		public $attachment_meta = null;

		/**
		 * The attachment_caption.
		 *
		 * @var string $attachment_caption The attachment_caption.
		 */
		public $attachment_caption = null;

		/**
		 * The attachment_orientation.
		 *
		 * @var string $attachment_orientation The attachment_orientation.
		 */
		public $attachment_orientation = null;

		/**
		 * __construct
		 *
		 * This function will initialize the initialize
		 *
		 * @param array $attributes The attributes of block.
		 * @param array $options    The options of block.
		 */
		public function __construct( $attributes, $options ) {
			$this->attributes = $attributes;
			$this->options    = $options;

			// Set source of entry.
			$this->source = $attributes['source'];
		}

		/**
		 * Init Entry
		 */
		public function init() {
			$this->set_object_id();
			$this->set_object_link();
			$this->set_attachment_id();
			$this->set_attachment_link();
			$this->set_attachment_link_to();
			$this->set_attachment_full_link();
			$this->set_attachment_html();
			$this->set_attachment_title();
			$this->set_attachment_title_tag();
			$this->set_attachment_meta();
			$this->set_attachment_caption();
			$this->set_attachment_orientation();
		}

		/**
		 * Set Object Id
		 */
		public function set_object_id() {
			if ( 'projects' === $this->source ) {
				$this->object_id = get_the_ID();
			}
			if ( 'categories' === $this->source ) {
				$this->object_id = intval( $this->object_id );
			}
			if ( 'post' === $this->source ) {
				$this->object_id = intval( $this->attachment_id );
			}
			if ( 'custom' === $this->source ) {
				$this->object_id = intval( $this->attachment_id );
			}
		}

		/**
		 * Set Object Link
		 */
		public function set_object_link() {
			if ( 'projects' === $this->source ) {
				$this->object_link = get_permalink( get_the_ID() );
			}
			if ( 'categories' === $this->source ) {
				$this->object_link = get_term_link( $this->object_id );

				if ( empty( CNVSPORT_ARCHIVE ) ) {
					$this->object_link = null;
				}
			}
			if ( 'post' === $this->source ) {
				$this->object_link = get_attachment_link( $this->attachment_id );
			}
			if ( 'custom' === $this->source ) {
				$this->object_link = get_attachment_link( $this->attachment_id );
			}
		}

		/**
		 * Set Attachment Id
		 */
		public function set_attachment_id() {
			if ( 'projects' === $this->source ) {
				$this->attachment_id = get_post_thumbnail_id();
			}
		}

		/**
		 * Set Attachment Link
		 */
		public function set_attachment_link() {
			$this->attachment_link = wp_get_attachment_image_url( $this->attachment_id, $this->attributes['attachment_size'] );
		}

		/**
		 * Set Attachment Full Link
		 */
		public function set_attachment_full_link() {
			$this->attachment_full_link = wp_get_attachment_image_url( $this->attachment_id, 'full' );
		}

		/**
		 * Set Attachment Html
		 */
		public function set_attachment_html() {
			$this->attachment_html = wp_get_attachment_image( $this->attachment_id, $this->attributes['attachment_size'] );
		}

		/**
		 * Set Attachment Link To
		 */
		public function set_attachment_link_to() {
			if ( empty( CNVSPORT_ARCHIVE ) && 'categories' === $this->source ) {

				$this->attachment_link_to = $this->attributes['attachment_link_to_short'];
			} else {
				$this->attachment_link_to = $this->attributes['attachment_link_to'];
			}
		}

		/**
		 * Set Attachment Title
		 */
		public function set_attachment_title() {
			if ( ! isset( $this->attributes['meta_title'] ) || ! $this->attributes['meta_title'] ) {
				return;
			}

			if ( 'projects' === $this->source ) {
				$this->attachment_title = get_the_title( $this->object_id );
			}
			if ( 'categories' === $this->source ) {
				$this->attachment_title = get_term( $this->object_id, 'cnvsport-categories' )->name;
			}
		}
		/**
		 * Set Attachment Title Tag
		 */
		public function set_attachment_title_tag() {
			if ( ! isset( $this->attributes['meta_title'] ) || ! $this->attributes['meta_title'] ) {
				return;
			}

			if ( isset( $this->attributes['typography_heading_tag'] ) ) {
				$this->attachment_title_tag = $this->attributes['typography_heading_tag'];
			}
		}

		/**
		 * Set Attachment Meta
		 */
		public function set_attachment_meta() {
			ob_start();

			// Meta Category.
			if ( isset( $this->attributes['meta_category'] ) && $this->attributes['meta_category'] ) {

				if ( 'projects' === $this->source ) {

					$terms_list = array();

					$terms = get_the_terms( $this->object_id, 'cnvsport-categories' );

					foreach ( $terms as $term ) {
						if ( CNVSPORT_ARCHIVE ) {
							$link = get_term_link( $term );

							if ( ! is_wp_error( $link ) ) {
								$terms_list[] = '<a class="cnvs-portfolio-meta-item" href="' . esc_url( $link ) . '" rel="tag">' . $term->name . '</a>';
							}
						} else {
							$terms_list[] = '<span class="cnvs-portfolio-meta-item">' . $term->name . '</span>';
						}
					}

					if ( $terms_list ) {
						?>
						<div class="cnvs-portfolio-meta-category">
							<?php call_user_func( 'printf', '%s', join( '', $terms_list ) ); ?>
						</div>
						<?php
					}
				}
			}

			// Meta Date.
			if ( isset( $this->attributes['meta_date'] ) && $this->attributes['meta_date'] ) {
				?>
				<div class="cnvs-portfolio-meta-date">
					<?php call_user_func( 'printf', '%s', get_the_date( '', $this->object_id ) ); ?>
				</div>
				<?php
			}

			$this->attachment_meta = ob_get_clean();
		}

		/**
		 * Set Attachment Caption
		 */
		public function set_attachment_caption() {
			if ( ! isset( $this->attributes['meta_caption'] ) || ! $this->attributes['meta_caption'] ) {
				return;
			}

			if ( 'projects' === $this->source ) {
				$this->attachment_caption = cnvsport_get_the_excerpt( $this->attributes['meta_caption_length'] );
			}
			if ( 'categories' === $this->source ) {
				$this->attachment_caption = cnvsport_str_truncate( term_description( $this->object_id ), $this->attributes['meta_caption_length'] );
			}
			if ( 'custom' === $this->source ) {
				$this->attachment_caption = cnvsport_str_truncate( wp_get_attachment_caption( $this->attachment_id ), $this->attributes['meta_caption_length'] );
			}
		}

		/**
		 * Set Attachment Orientation
		 */
		public function set_attachment_orientation() {
			if ( isset( $this->attributes['attachment_orientation'] ) ) {
				$this->attachment_orientation = sprintf( 'cnvs-portfolio-overlay-ratio cnvs-portfolio-ratio-%s', $this->attributes['attachment_orientation'] );
			}
		}

		/**
		 * Has Item Content
		 */
		public function has_item_content() {
			if ( $this->attachment_title ) {
				return true;
			}
			if ( $this->attachment_meta ) {
				return true;
			}
			if ( $this->attachment_caption ) {
				return true;
			}
		}

		/**
		 * Compile Item Class
		 *
		 * @param string $class The class of entry.
		 */
		public function item_class( $class = array() ) {
			$classes = array();

			if ( $class ) {
				if ( ! is_array( $class ) ) {
					$class = preg_split( '#\s+#', $class );
				}
				$classes = array_map( 'esc_attr', $class );
			} else {
				// Ensure that we always coerce class to being an array.
				$class = array();
			}

			// Set individual class.
			$classes[] = 'cnvs-portfolio-entry cnvs-portfolio-video-wrap';

			// Set entry request class.
			if ( 'standard' === $this->attributes['layout'] ) {
				if ( isset( $_REQUEST['action'] ) && 'cnvsport_portfolio_ajax_load_more' === $_REQUEST['action'] ) {
					$classes[] = 'cnvs-portfolio-entry-request';
				}
			}

			// For projects.
			if ( 'projects' === $this->source ) {
				$post = get_post( get_the_ID() );

				$classes[] = 'type-' . $post->post_type;
				$classes[] = 'status-' . $post->post_status;

				// Post thumbnails.
				if ( current_theme_supports( 'post-thumbnails' ) && has_post_thumbnail( $post->ID ) && ! is_attachment( $post ) ) {
					$classes[] = 'has-post-thumbnail';
				}
			}

			call_user_func( 'printf', 'class="%s"', join( ' ', $classes ) );
		}

		/**
		 * Compile Item Attachment
		 */
		public function item_attachment() {
			if ( ! $this->attachment_html ) {
				return;
			}

			switch ( $this->attachment_link_to ) {
				case 'media':
					$attachment_link = $this->attachment_full_link;
					break;
				case 'page':
					$attachment_link = $this->object_link;
					break;
			}
			?>
			<div class="cnvs-portfolio-entry__inner cnvs-portfolio-entry__thumbnail cnvs-portfolio-entry__overlay <?php echo esc_attr( $this->attachment_orientation ); ?>">
				<div class="cnvs-portfolio-overlay-background">
					<?php
					call_user_func( 'printf', '%s', $this->attachment_html );

					if ( isset( $this->attributes['video'] ) && $this->attributes['video'] && 'none' !== $this->attributes['video'] ) {
						cnvsport_get_video_background( $this->attributes['video'], null, null, 'default', $this->attributes['video_contrlos'] );
					}
					?>
				</div>

				<?php
				if ( isset( $attachment_link ) ) {
					?>
					<a class="cnvs-portfolio-overlay-link" href="<?php echo esc_url( $attachment_link ); ?>"></a>
					<?php
				}
				?>
			</div>
			<?php
		}

		/**
		 * Compile Item Content
		 */
		public function item_content() {
			if ( $this->has_item_content() ) {
				?>
				<div class="cnvs-portfolio-entry__inner cnvs-portfolio-entry__content">
					<?php if ( $this->attachment_title ) { ?>
						<div class="cnvs-portfolio-entry__title">
							<?php if ( $this->object_link ) { ?>
								<<?php echo esc_html( $this->attachment_title_tag ); ?> class="cnvs-portfolio-entry__heading">
									<a href="<?php echo esc_url( $this->object_link ); ?>">
										<?php echo wp_kses( $this->attachment_title, 'post' ); ?>
									</a>
								</<?php echo esc_html( $this->attachment_title_tag ); ?>>
							<?php } else { ?>
								<<?php echo esc_html( $this->attachment_title_tag ); ?> class="cnvs-portfolio-entry__heading">
									<?php echo wp_kses( $this->attachment_title, 'post' ); ?>
								</<?php echo esc_html( $this->attachment_title_tag ); ?>>
							<?php } ?>
						</div>
					<?php } ?>

					<?php if ( $this->attachment_meta ) { ?>
						<div class="cnvs-portfolio-entry__meta">
							<?php echo wp_kses( $this->attachment_meta, 'post' ); ?>
						</div>
					<?php } ?>

					<?php if ( $this->attachment_caption ) { ?>
						<div class="cnvs-portfolio-entry__caption">
							<?php echo wp_kses( $this->attachment_caption, 'post' ); ?>
						</div>
					<?php } ?>
				</div>
				<?php
			}
		}
	}
}
