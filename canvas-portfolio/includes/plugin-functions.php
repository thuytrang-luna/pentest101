<?php
/**
 * Plugin Functions
 *
 * Utility functions.
 *
 * @package Canvas Portfolio
 */

if ( ! function_exists( 'cnvsport_doing_request' ) ) {
	/**
	 * Determines whether the current request is a WordPress REST or Ajax request.
	 */
	function cnvsport_doing_request() {
		if ( defined( 'REST_REQUEST' ) && REST_REQUEST ) {
			return true;
		}
		if ( defined( 'DOING_AJAX' ) && DOING_AJAX ) {
			return true;
		}
	}
}

if ( ! function_exists( 'cnvsport_is_context_editor' ) ) {
	/**
	 * Determines whether the current request is from WordPress Editor.
	 */
	function cnvsport_is_context_editor() {
		wp_verify_nonce( null );

		if ( isset( $_REQUEST['context'] ) && 'edit' === $_REQUEST['context'] ) { // Input var ok; sanitization ok.
			return true;
		}
	}
}

if ( ! function_exists( 'cnvsport_encode_data' ) ) {
	/**
	 * Encode data
	 *
	 * @param  mixed  $content    The content.
	 * @param  string $secret_key The key.
	 * @return string
	 */
	function cnvsport_encode_data( $content, $secret_key = 'canvas' ) {

		$content = wp_json_encode( $content );

		return base64_encode( $content );
	}
}

if ( ! function_exists( 'cnvsport_decode_data' ) ) {
	/**
	 * Decode data
	 *
	 * @param  string $content    The content.
	 * @param  string $secret_key The key.
	 * @return string
	 */
	function cnvsport_decode_data( $content, $secret_key = 'canvas' ) {

		$content = base64_decode( $content );

		return json_decode( $content );
	}
}

if ( ! function_exists( 'cnvsport_get_available_image_sizes' ) ) {
	/**
	 * Get the available image sizes
	 */
	function cnvsport_get_available_image_sizes() {
		$wais = & $GLOBALS['_wp_additional_image_sizes'];

		$sizes       = array();
		$image_sizes = get_intermediate_image_sizes();

		if ( is_array( $image_sizes ) && $image_sizes ) {
			foreach ( $image_sizes as $size ) {
				if ( in_array( $size, array( 'thumbnail', 'medium', 'medium_large', 'large' ), true ) ) {
					$sizes[ $size ] = array(
						'width'  => get_option( "{$size}_size_w" ),
						'height' => get_option( "{$size}_size_h" ),
						'crop'   => (bool) get_option( "{$size}_crop" ),
					);
				} elseif ( isset( $wais[ $size ] ) ) {
					$sizes[ $size ] = array(
						'width'  => $wais[ $size ]['width'],
						'height' => $wais[ $size ]['height'],
						'crop'   => $wais[ $size ]['crop'],
					);
				}

				// Size registered, but has 0 width and height.
				if ( 0 === (int) $sizes[ $size ]['width'] && 0 === (int) $sizes[ $size ]['height'] ) {
					unset( $sizes[ $size ] );
				}
			}
		}

		return $sizes;
	}
}

if ( ! function_exists( 'cnvsport_get_image_size' ) ) {
	/**
	 * Gets the data of a specific image size.
	 *
	 * @param string $size Name of the size.
	 */
	function cnvsport_get_image_size( $size ) {
		if ( ! is_string( $size ) ) {
			return;
		}

		$sizes = cnvsport_get_available_image_sizes();

		return isset( $sizes[ $size ] ) ? $sizes[ $size ] : false;
	}
}

if ( ! function_exists( 'cnvsport_get_list_available_image_sizes' ) ) {
	/**
	 * Get the list available image sizes
	 */
	function cnvsport_get_list_available_image_sizes() {

		$image_sizes = wp_cache_get( 'cnvsport_available_image_sizes' );

		if ( empty( $image_sizes ) ) {
			$image_sizes = array();

			$intermediate_image_sizes = get_intermediate_image_sizes();

			foreach ( $intermediate_image_sizes as $size ) {
				$image_sizes[ $size ] = $size;

				$data = cnvsport_get_image_size( $size );

				if ( isset( $data['width'] ) || isset( $data['height'] ) ) {

					$width  = '~';
					$height = '~';

					if ( isset( $data['width'] ) && $data['width'] ) {
						$width = $data['width'] . 'px';
					}
					if ( isset( $data['height'] ) && $data['height'] ) {
						$height = $data['height'] . 'px';
					}

					$image_sizes[ $size ] .= sprintf( ' [%s, %s]', $width, $height );
				}
			}

			wp_cache_set( 'cnvsport_available_image_sizes', $image_sizes );
		}

		return $image_sizes;
	}
}

if ( ! function_exists( 'cnvsport_str_truncate' ) ) {
	/**
	 * Truncates string with specified length
	 *
	 * @param  string $string      Text string.
	 * @param  int    $length      Letters length.
	 * @param  string $etc         End truncate.
	 * @param  bool   $break_words Break words or not.
	 * @return string
	 */
	function cnvsport_str_truncate( $string, $length = 80, $etc = '&hellip;', $break_words = false ) {
		if ( 0 === $length ) {
			return '';
		}

		if ( function_exists( 'mb_strlen' ) ) {

			// MultiBite string functions.
			if ( mb_strlen( $string ) > $length ) {
				$length -= min( $length, mb_strlen( $etc ) );
				if ( ! $break_words ) {
					$string = preg_replace( '/\s+?(\S+)?$/', '', mb_substr( $string, 0, $length + 1 ) );
				}

				return mb_substr( $string, 0, $length ) . $etc;
			}
		} else {

			// Default string functions.
			if ( strlen( $string ) > $length ) {
				$length -= min( $length, strlen( $etc ) );
				if ( ! $break_words ) {
					$string = preg_replace( '/\s+?(\S+)?$/', '', substr( $string, 0, $length + 1 ) );
				}

				return substr( $string, 0, $length ) . $etc;
			}
		}

		return $string;
	}
}

if ( ! function_exists( 'cnvsport_get_the_excerpt' ) ) {
	/**
	 * Filters the number of words in an excerpt.
	 */
	function cnvsport_get_the_excerpt_length() {
		return 5000;
	}

	/**
	 * Get excerpt of post.
	 *
	 * @param int    $length      Letters length.
	 * @param string $etc         End truncate.
	 * @param bool   $break_words Break words or not.
	 */
	function cnvsport_get_the_excerpt( $length = 80, $etc = '&hellip;', $break_words = false ) {
		add_filter( 'excerpt_length', 'cnvsport_get_the_excerpt_length' );

		$excerpt = get_the_excerpt();

		$func_remove = sprintf( 'remove_%s', 'filter' );

		$func_remove( 'excerpt_length', 'cnvsport_get_the_excerpt_length' );

		return cnvsport_str_truncate( $excerpt, $length, $etc, $break_words );
	}
}

if ( ! function_exists( 'cnvsport_get_post_types_stack' ) ) {
	/**
	 * Get portfolio post types.
	 */
	function cnvsport_get_post_types_stack() {

		$stack = wp_cache_get( 'cnvsport_get_post_types_stack' );

		if ( ! $stack ) {

			$stack = array();

			$post_types = get_post_types( array( 'publicly_queryable' => 1 ), 'objects' );

			foreach ( $post_types as $post_type ) {
				$stack[ $post_type->name ] = $post_type->label;
			}

			wp_cache_set( 'cnvsport_get_post_types_stack', $stack );
		}

		return $stack ? $stack : array();
	}
}

if ( ! function_exists( 'cnvsport_get_categories_stack' ) ) {
	/**
	 * Get portfolio categories.
	 */
	function cnvsport_get_categories_stack() {

		$stack = wp_cache_get( 'cnvsport_get_categories_stack' );

		if ( ! $stack ) {

			$stack = array();

			$categories = get_terms(
				array(
					'taxonomy'   => 'cnvsport-categories',
					'hide_empty' => false,
				)
			);

			foreach ( $categories as $category ) {
				$stack[ $category->term_id ] = $category->name;
			}

			wp_cache_set( 'cnvsport_get_categories_stack', $stack );
		}

		return $stack ? $stack : array();
	}
}

if ( ! function_exists( 'cnvsport_portfolio_area_classes' ) ) {
	/**
	 * Get portfolio area classes.
	 *
	 * @param array $attributes The attributes.
	 * @param array $options    The options.
	 */
	function cnvsport_portfolio_area_classes( $attributes, $options ) {
		$classes = array( 'cnvs-portfolio-area' );

		// Set block name.
		$classes[] = $attributes['className'];

		// Apply filters.
		$classes = apply_filters( 'cnvsport_portfolio_area_classes', $classes, $attributes, $options );

		// Build class.
		$class = implode( ' ', $classes );

		// Return.
		return $class;
	}
}

if ( ! function_exists( 'cnvsport_portfolio_area_main_attrs' ) ) {
	/**
	 * Output portfolio area main attrs.
	 *
	 * @param array $attributes The attributes.
	 * @param array $options    The options.
	 */
	function cnvsport_portfolio_area_main_attrs( $attributes, $options ) {
		// Apply filters.
		$attrs = apply_filters( 'cnvsport_portfolio_area_main_attrs', '', $attributes, $options );

		// Return.
		return call_user_func( 'printf', '%s', $attrs );
	}
}

if ( ! function_exists( 'cnvsport_get_youtube_video_id' ) ) {
	/**
	 * Get Youtube video ID from URL
	 *
	 * @param string $url YouTube URL.
	 */
	function cnvsport_get_youtube_video_id( $url ) {
		preg_match( '/(http(s|):|)\/\/(www\.|)yout(.*?)\/(embed\/|watch.*?v=|)([a-z_A-Z0-9\-]{11})/i', $url, $results );

		if ( isset( $results[6] ) && $results[6] ) {
			return $results[6];
		}
	}
}
if ( ! function_exists( 'cnvsport_get_local_video_url' ) ) {
	/**
	 * Get local video URL
	 *
	 * @param string $url Local URL.
	 */
	function cnvsport_get_local_video_url( $url ) {
		if ( attachment_url_to_postid( $url ) ) {
			return $url;
		}
	}
}

if ( ! function_exists( 'cnvsport_get_video_background' ) ) {
	/**
	 * Get element video background
	 *
	 * @param string $type     The type.
	 * @param string $location The current location.
	 * @param int    $post_id  The id of post.
	 * @param string $template Template.
	 * @param bool   $controls Display tools.
	 */
	function cnvsport_get_video_background( $type = 'always', $location = null, $post_id = null, $template = 'default', $controls = true ) {
		if ( cnvsport_is_context_editor() ) {
			return;
		}

		if ( is_customize_preview() ) {
			return;
		}

		if ( ! $post_id ) {
			$post_id = get_the_ID();
		}

		// Params.
		$url   = get_post_meta( $post_id, 'cnvsport_post_video_url', true );
		$start = get_post_meta( $post_id, 'cnvsport_post_video_bg_start_time', true );
		$end   = get_post_meta( $post_id, 'cnvsport_post_video_bg_end_time', true );

		// Location.
		if ( $location ) {
			$support = (array) get_post_meta( $post_id, 'cnvsport_post_video_location', true );

			if ( ! in_array( $location, $support, true ) ) {
				return;
			}
		}

		// Video info.
		$local_url  = cnvsport_get_local_video_url( $url );
		$youtube_id = cnvsport_get_youtube_video_id( $url );

		// Output.
		if ( $youtube_id || $local_url ) {
			// Get video mode.
			$mode = $youtube_id ? 'youtube' : 'local';

			// Controls.
			if ( true === $controls ) {
				$controls = array( 'youtube', 'volume', 'state' );

				if ( 'hover' === $type ) {
					$controls = array_diff( $controls, array( 'state' ) );
				}
				if ( 'local' === $mode ) {
					$controls = array_diff( $controls, array( 'youtube' ) );
				}
			}
			?>
			<div class="cnvs-portfolio-video-container" data-video-type="<?php echo esc_attr( $type ); ?>" data-video-mode="<?php echo esc_attr( $mode ); ?>" data-youtube-id="<?php echo esc_attr( $youtube_id ); ?>" data-video-start="<?php echo esc_attr( (int) $start ); ?>" data-video-end="<?php echo esc_attr( (int) $end ); ?>">
				<?php if ( $youtube_id ) { ?>
					<div class="cnvs-portfolio-video-inner"></div>
				<?php } else { ?>
					<video class="cnvs-portfolio-video-inner" loop muted>
						<source src="<?php echo esc_attr( $local_url ); ?>" type="video/webm" />
					</video>
				<?php } ?>

				<div class="cnvs-portfolio-video-loader"></div>
			</div>

			<?php if ( is_array( $controls ) && $controls ) { ?>
				<div class="cnvs-portfolio-video-controls cnvs-portfolio-video-controls-<?php echo esc_attr( $template ); ?>">
					<?php if ( in_array( 'youtube', $controls, true ) ) { ?>
						<a class="cnvs-portfolio-player-control cnvs-portfolio-player-link cnvs-portfolio-player-stop" target="_blank" href="<?php echo esc_url( $url ); ?>">
							<span class="cnvs-portfolio-tooltip"><span><?php esc_html_e( 'View on YouTube', 'canvas-portfolio' ); ?></span></span>
						</a>
					<?php } ?>

					<?php if ( in_array( 'volume', $controls, true ) ) { ?>
						<span class="cnvs-portfolio-player-control cnvs-portfolio-player-volume cnvs-portfolio-player-mute"></span>
					<?php } ?>

					<?php if ( in_array( 'state', $controls, true ) ) { ?>
						<span class="cnvs-portfolio-player-control cnvs-portfolio-player-state cnvs-portfolio-player-pause"></span>
					<?php } ?>
				</div>
			<?php } ?>
			<?php
		}
	}
}
