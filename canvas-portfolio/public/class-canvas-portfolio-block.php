<?php
/**
 * The Gutenberg Block.
 *
 * @link       https://codesupply.co
 * @since      1.0.0
 *
 * @package    Canvas Portfolio
 * @subpackage Canvas Portfolio/includes
 */

/**
 * The initialize block.
 */
class CNVSPort_Block {

	/**
	 * Initialize
	 */
	public function __construct() {
		add_action( 'init', array( $this, 'block' ) );
		add_filter( 'canvas_register_block_type', array( $this, 'register_block_type' ) );
	}

	/**
	 * Enqueue the block's assets for the editor.
	 */
	public function block() {
		// Scripts.
		wp_register_script(
			'canvas-portfolio-block-script',
			CNVSPORT_URL . 'public/js/canvas-portfolio.js',
			array( 'jquery' ),
			filemtime( CNVSPORT_PATH . 'public/js/canvas-portfolio.js' ),
			true
		);

		// Styles.
		wp_register_style(
			'canvas-portfolio-block-style',
			CNVSPORT_URL . 'public/css/canvas-portfolio-layout-standard.css',
			array(),
			filemtime( CNVSPORT_PATH . 'public/css/canvas-portfolio-layout-standard.css' )
		);

		wp_style_add_data( 'canvas-portfolio-block-style', 'rtl', 'replace' );
	}

	/**
	 * Register block
	 *
	 * @param array $blocks all registered blocks.
	 * @return array
	 */
	public function register_block_type( $blocks ) {
		$blocks[] = array(
			'name'          => 'canvas/portfolio',
			'title'         => esc_html__( 'Portfolio', 'canvas-portfolio' ),
			'description'   => esc_html__( 'The block allows you to display portfolio.', 'canvas-portfolio' ),
			'category'      => 'canvas',
			'keywords'      => array(),
			'icon'          => '<svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true" focusable="false"><path d="M20 4v12H8V4h12m0-2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 9.67l1.69 2.26 2.48-3.1L19 15H9zM2 6v14c0 1.1.9 2 2 2h14v-2H4V6H2z"></path></svg>',
			'supports'      => array(
				'className'        => true,
				'anchor'           => true,
				'html'             => false,
				'canvasSpacings'   => true,
				'canvasBorder'     => true,
				'canvasResponsive' => true,
			),
			'styles'        => array(),
			'location'      => array(),
			'sections'      => array(
				'general'        => array(
					'title'    => esc_html__( 'Block Settings', 'canvas-portfolio' ),
					'priority' => 5,
					'open'     => true,
				),
				'meta'           => array(
					'title'    => esc_html__( 'Meta Settings', 'canvas-portfolio' ),
					'priority' => 10,
				),
				'attachment'     => array(
					'title'    => esc_html__( 'Attachment Settings', 'canvas-portfolio' ),
					'priority' => 20,
				),
				'typography'     => array(
					'title'    => esc_html__( 'Typography Settings', 'canvas-portfolio' ),
					'priority' => 30,
				),
				'query'          => array(
					'title'    => esc_html__( 'Query Settings', 'canvas-portfolio' ),
					'priority' => 40,
				),
				'pagination'     => array(
					'title'    => esc_html__( 'Pagination Settings', 'canvas-portfolio' ),
					'priority' => 50,
				),
				'buttonSettings' => array(
					'title'    => esc_html__( 'Button Settings', 'canvas-portfolio' ),
					'priority' => 60,
				),
				'color'          => array(
					'title'    => esc_html__( 'Color Settings', 'canvas-portfolio' ),
					'priority' => 70,
				),
			),
			'layouts'       => array(
				'standard' => array(
					'name'     => esc_html__( 'Standard', 'canvas-portfolio' ),
					'icon'     => '<svg height="44" width="52" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 44.69 29.75"><path d="M1.55.75h9.59a.8.8 0 01.8.8v9.64a.8.8 0 01-.8.81H1.55a.8.8 0 01-.8-.81V1.55a.8.8 0 01.8-.8zM17.55.75h9.59a.8.8 0 01.8.8v9.64a.8.8 0 01-.8.81h-9.59a.8.8 0 01-.8-.81V1.55a.8.8 0 01.8-.8zM33.55.75h9.59a.8.8 0 01.8.8v9.64a.8.8 0 01-.8.81h-9.59a.8.8 0 01-.8-.81V1.55a.8.8 0 01.8-.8zM1.55 17.75h9.59a.8.8 0 01.8.8v9.64a.8.8 0 01-.8.81H1.55a.8.8 0 01-.8-.81v-9.64a.8.8 0 01.8-.8zM17.55 17.75h9.59a.8.8 0 01.8.8v9.64a.8.8 0 01-.8.81h-9.59a.8.8 0 01-.8-.81v-9.64a.8.8 0 01.8-.8zM33.55 17.75h9.59a.8.8 0 01.8.8v9.64a.8.8 0 01-.8.81h-9.59a.8.8 0 01-.8-.81v-9.64a.8.8 0 01.8-.8z" fill="none" stroke="#2d2d2d" stroke-width="1.5"/></svg>',
					'location' => array(),
					'template' => dirname( __FILE__ ) . '/block/post-area-init.php',
					'sections' => array(),
					'fields'   => array(
						array(
							'key'             => 'filter_items',
							'label'           => esc_html__( 'Enable filter of projects', 'canvas-portfolio' ),
							'section'         => 'general',
							'type'            => 'toggle',
							'default'         => true,
							'active_callback' => array(
								array(
									'field'    => 'source',
									'operator' => '==',
									'value'    => 'projects',
								),
								array(
									'field'    => 'projects_filter_post_type',
									'operator' => '==',
									'value'    => 'cnvsport-projects',
								),
							),
						),
						array(
							'key'             => 'pagination_type',
							'label'           => esc_html__( 'Pagination type', 'canvas-portfolio' ),
							'section'         => 'general',
							'type'            => 'select',
							'default'         => 'ajax',
							'choices'         => array(
								'none'     => esc_html__( 'None', 'canvas-portfolio' ),
								'ajax'     => esc_html__( 'Load More', 'canvas-portfolio' ),
								'infinite' => esc_html__( 'Infinite Load', 'canvas-portfolio' ),
							),
							'active_callback' => array(
								array(
									'field'    => 'source',
									'operator' => '==',
									'value'    => 'projects',
								),
							),
						),
						array(
							'key'            => 'columns',
							'label'          => esc_html__( 'Number of Columns', 'canvas-portfolio' ),
							'section'        => 'general',
							'type'           => 'number',
							'min'            => 1,
							'max'            => 6,
							'default'        => 1,
							'default_tablet' => 1,
							'default_mobile' => 1,
							'responsive'     => true,
							'output'         => array(
								array(
									'element'  => '$ .cnvs-portfolio-area__main',
									'property' => '--cnvs-portfolio-area-grid-columns',
									'suffix'   => '!important',
								),
							),
						),
						array(
							'key'            => 'gap_posts',
							'label'          => esc_html__( 'Gap between Items', 'canvas-portfolio' ),
							'type'           => 'dimension',
							'section'        => 'general',
							'responsive'     => true,
							'default'        => '40px',
							'default_tablet' => '40px',
							'default_mobile' => '40px',
							'output'         => array(
								array(
									'element'  => '$ .cnvs-portfolio-area__main',
									'property' => '--cnvs-portfolio-area-grid-gap',
									'suffix'   => '!important',
								),
							),
						),
					),
				),
			),
			'fields'        => array(
				// Common.
				array(
					'key'     => 'source',
					'label'   => esc_html__( 'Source', 'canvas-portfolio' ),
					'section' => 'general',
					'type'    => 'select',
					'default' => 'projects',
					'choices' => array(
						'projects'   => esc_html__( 'Projects', 'canvas-portfolio' ),
						'custom'     => esc_html__( 'Images', 'canvas-portfolio' ),
						'categories' => esc_html__( 'Categories', 'canvas-portfolio' ),
						'post'       => esc_html__( 'Post Attachments', 'canvas-portfolio' ),
					),
				),
				// Attachment.
				array(
					'key'             => 'attachment_link_to',
					'label'           => esc_html__( 'Link To', 'canvas-portfolio' ),
					'section'         => 'attachment',
					'type'            => 'select',
					'default'         => 'page',
					'choices'         => array(
						'none'  => esc_html__( 'None', 'canvas-portfolio' ),
						'media' => esc_html__( 'Media File', 'canvas-portfolio' ),
						'page'  => esc_html__( 'Page', 'canvas-portfolio' ),
					),
					'active_callback' => CNVSPORT_ARCHIVE ? array() : array(
						array(
							'field'    => 'source',
							'operator' => '!=',
							'value'    => 'categories',
						),
					),
				),
				CNVSPORT_ARCHIVE ? array() : array(
					'key'             => 'attachment_link_to_short',
					'label'           => esc_html__( 'Link To', 'canvas-portfolio' ),
					'section'         => 'attachment',
					'type'            => 'select',
					'default'         => 'page',
					'choices'         => array(
						'none'  => esc_html__( 'None', 'canvas-portfolio' ),
						'media' => esc_html__( 'Media File', 'canvas-portfolio' ),
					),
					'active_callback' => array(
						array(
							'field'    => 'source',
							'operator' => '==',
							'value'    => 'categories',
						),
					),
				),
				array(
					'key'     => 'attachment_size',
					'label'   => esc_html__( 'Size', 'canvas-portfolio' ),
					'section' => 'attachment',
					'type'    => 'select',
					'default' => 'large',
					'choices' => cnvsport_get_list_available_image_sizes(),
				),
				array(
					'key'     => 'attachment_orientation',
					'label'   => esc_html__( 'Orientation', 'canvas-portfolio' ),
					'section' => 'attachment',
					'type'    => 'select',
					'default' => 'landscape-16-9',
					'choices' => array(
						'original'       => esc_html__( 'Original', 'canvas-portfolio' ),
						'landscape-4-3'  => esc_html__( 'Landscape 4:3', 'canvas-portfolio' ),
						'landscape-3-2'  => esc_html__( 'Landscape 3:2', 'canvas-portfolio' ),
						'landscape-16-9' => esc_html__( 'Landscape 16:9', 'canvas-portfolio' ),
						'portrait-3-4'   => esc_html__( 'Portrait 3:4', 'canvas-portfolio' ),
						'portrait-2-3'   => esc_html__( 'Portrait 2:3', 'canvas-portfolio' ),
						'square'         => esc_html__( 'Square', 'canvas-portfolio' ),
					),
				),
				// Meta.
				array(
					'key'             => 'meta_title',
					'label'           => esc_html__( 'Display item title', 'canvas-portfolio' ),
					'section'         => 'meta',
					'type'            => 'toggle',
					'default'         => true,
					'active_callback' => array(
						array(
							'field'    => 'source',
							'operator' => '!=',
							'value'    => 'post',
						),
						array(
							'field'    => 'source',
							'operator' => '!=',
							'value'    => 'custom',
						),
					),
				),
				array(
					'key'     => 'meta_caption',
					'label'   => esc_html__( 'Display item caption', 'canvas-portfolio' ),
					'section' => 'meta',
					'type'    => 'toggle',
					'default' => true,
				),
				array(
					'key'             => 'meta_caption_length',
					'label'           => esc_html__( 'Caption length', 'canvas-portfolio' ),
					'section'         => 'meta',
					'type'            => 'number',
					'step'            => 1,
					'min'             => 1,
					'max'             => 1000,
					'default'         => 100,
					'active_callback' => array(
						array(
							'field'    => 'meta_caption',
							'operator' => '==',
							'value'    => true,
						),
					),
				),
				array(
					'key'             => 'meta_category',
					'label'           => esc_html__( 'Display meta category', 'canvas-portfolio' ),
					'section'         => 'meta',
					'type'            => 'toggle',
					'default'         => false,
					'active_callback' => array(
						array(
							'field'    => 'source',
							'operator' => '==',
							'value'    => 'projects',
						),
						array(
							'field'    => 'projects_filter_post_type',
							'operator' => '==',
							'value'    => 'cnvsport-projects',
						),
					),
				),
				array(
					'key'             => 'meta_date',
					'label'           => esc_html__( 'Display meta date', 'canvas-portfolio' ),
					'section'         => 'meta',
					'type'            => 'toggle',
					'default'         => false,
					'active_callback' => array(
						array(
							'field'    => 'source',
							'operator' => '!=',
							'value'    => 'categories',
						),
					),
				),
				// Typography.
				array(
					'key'             => 'typography_heading',
					'label'           => esc_html__( 'Heading Font Size', 'canvas-portfolio' ),
					'section'         => 'typography',
					'type'            => 'dimension',
					'default'         => '',
					'responsive'      => true,
					'output'          => array(
						array(
							'element'  => '$ .cnvs-portfolio-entry__heading',
							'property' => 'font-size',
							'suffix'   => '!important',
						),
					),
					'active_callback' => array(
						array(
							'field'    => 'source',
							'operator' => '!=',
							'value'    => 'post',
						),
						array(
							'field'    => 'source',
							'operator' => '!=',
							'value'    => 'custom',
						),
						array(
							'field'    => 'meta_title',
							'operator' => '==',
							'value'    => true,
						),
					),
				),
				array(
					'key'             => 'typography_heading_tag',
					'label'           => esc_html__( 'Heading Tag', 'canvas-portfolio' ),
					'section'         => 'typography',
					'type'            => 'select',
					'default'         => 'h3',
					'choices'         => array(
						'h1'  => esc_html__( 'H1', 'canvas-portfolio' ),
						'h2'  => esc_html__( 'H2', 'canvas-portfolio' ),
						'h3'  => esc_html__( 'H3', 'canvas-portfolio' ),
						'h4'  => esc_html__( 'H4', 'canvas-portfolio' ),
						'h5'  => esc_html__( 'H5', 'canvas-portfolio' ),
						'h6'  => esc_html__( 'H6', 'canvas-portfolio' ),
						'p'   => esc_html__( 'P', 'canvas-portfolio' ),
						'div' => esc_html__( 'DIV', 'canvas-portfolio' ),
					),
					'active_callback' => array(
						array(
							'field'    => 'source',
							'operator' => '!=',
							'value'    => 'post',
						),
						array(
							'field'    => 'source',
							'operator' => '!=',
							'value'    => 'custom',
						),
						array(
							'field'    => 'meta_title',
							'operator' => '==',
							'value'    => true,
						),
					),
				),
				array(
					'key'             => 'typography_caption',
					'label'           => esc_html__( 'Caption Font Size', 'canvas-portfolio' ),
					'section'         => 'typography',
					'type'            => 'dimension',
					'default'         => '',
					'responsive'      => true,
					'output'          => array(
						array(
							'element'  => '$ .cnvs-portfolio-entry__caption',
							'property' => 'font-size',
							'suffix'   => '!important',
						),
					),
					'active_callback' => array(
						array(
							'field'    => 'meta_caption',
							'operator' => '==',
							'value'    => true,
						),
					),
				),
				// Color.
				array(
					'key'             => 'color_heading',
					'label'           => esc_html__( 'Heading Color', 'canvas-portfolio' ),
					'section'         => 'color',
					'type'            => 'color',
					'output'          => array(
						array(
							'element'  => '$ .cnvs-portfolio-entry__heading, $ .cnvs-portfolio-entry__heading a',
							'property' => 'color',
							'suffix'   => '!important',
						),
					),
					'active_callback' => array(
						array(
							'field'    => 'source',
							'operator' => '!=',
							'value'    => 'post',
						),
						array(
							'field'    => 'source',
							'operator' => '!=',
							'value'    => 'custom',
						),
						array(
							'field'    => 'meta_title',
							'operator' => '==',
							'value'    => true,
						),
					),
				),
				array(
					'key'             => 'color_heading_hover',
					'label'           => esc_html__( 'Heading Hover Color', 'canvas-portfolio' ),
					'section'         => 'color',
					'type'            => 'color',
					'output'          => array(
						array(
							'element'  => '$ .cnvs-portfolio-entry__heading a:hover',
							'property' => 'color',
							'suffix'   => '!important',
						),
					),
					'active_callback' => array(
						array(
							'field'    => 'source',
							'operator' => '!=',
							'value'    => 'post',
						),
						array(
							'field'    => 'source',
							'operator' => '!=',
							'value'    => 'custom',
						),
						array(
							'field'    => 'meta_title',
							'operator' => '==',
							'value'    => true,
						),
					),
				),
				array(
					'key'             => 'color_caption',
					'label'           => esc_html__( 'Caption Color', 'canvas-portfolio' ),
					'section'         => 'color',
					'type'            => 'color',
					'output'          => array(
						array(
							'element'  => '$ .cnvs-portfolio-entry__caption',
							'property' => 'color',
							'suffix'   => '!important',
						),
					),
					'active_callback' => array(
						array(
							'field'    => 'meta_caption',
							'operator' => '==',
							'value'    => true,
						),
					),
				),
				// Query.
				array(
					'key'             => 'projects_filter_post_type',
					'label'           => esc_html__( 'Filter by Post Type', 'canvas-portfolio' ),
					'section'         => 'query',
					'type'            => 'select',
					'multiple'        => false,
					'choices'         => cnvsport_get_post_types_stack(),
					'default'         => 'cnvsport-projects',
					'active_callback' => array(
						array(
							'field'    => 'source',
							'operator' => '==',
							'value'    => 'projects',
						),
					),
				),
				array(
					'key'             => 'projects_filter_categories',
					'label'           => esc_html__( 'Filter by Categories', 'canvas-portfolio' ),
					'section'         => 'query',
					'type'            => 'react-select',
					'multiple'        => true,
					'items'           => array(
						'type' => 'integer',
					),
					'choices'         => cnvsport_get_categories_stack(),
					'active_callback' => array(
						array(
							'field'    => 'source',
							'operator' => '==',
							'value'    => 'projects',
						),
						array(
							'field'    => 'projects_filter_post_type',
							'operator' => '==',
							'value'    => 'cnvsport-projects',
						),
					),
				),
				array(
					'key'             => 'projects_filter_offset',
					'label'           => esc_html__( 'Offset', 'canvas-portfolio' ),
					'section'         => 'query',
					'type'            => 'text',
					'active_callback' => array(
						array(
							'field'    => 'source',
							'operator' => '==',
							'value'    => 'projects',
						),
					),
				),
				array(
					'key'             => 'projects_orderby',
					'label'           => esc_html__( 'Order By', 'canvas-portfolio' ),
					'section'         => 'query',
					'type'            => 'select',
					'default'         => 'date',
					'choices'         => array(
						'date'          => esc_html__( 'Published Date', 'canvas-portfolio' ),
						'modified'      => esc_html__( 'Modified Date', 'canvas-portfolio' ),
						'title'         => esc_html__( 'Title', 'canvas-portfolio' ),
						'rand'          => esc_html__( 'Random', 'canvas-portfolio' ),
						'views'         => esc_html__( 'Views', 'canvas-portfolio' ),
						'comment_count' => esc_html__( 'Comment Count', 'canvas-portfolio' ),
						'ID'            => esc_html__( 'ID', 'canvas-portfolio' ),
					),
					'active_callback' => array(
						array(
							'field'    => 'source',
							'operator' => '==',
							'value'    => 'projects',
						),
					),
				),
				array(
					'key'             => 'projects_order',
					'label'           => esc_html__( 'Order', 'canvas-portfolio' ),
					'section'         => 'query',
					'type'            => 'select',
					'default'         => 'date',
					'choices'         => array(
						'DESC' => esc_html__( 'Descending', 'canvas-portfolio' ),
						'ASC'  => esc_html__( 'Ascending', 'canvas-portfolio' ),
					),
					'active_callback' => array(
						array(
							'field'    => 'source',
							'operator' => '==',
							'value'    => 'projects',
						),
					),
				),
				array(
					'key'             => 'categories_filter_ids',
					'label'           => esc_html__( 'Filter by Categories', 'canvas-portfolio' ),
					'section'         => 'query',
					'type'            => 'react-select',
					'multiple'        => true,
					'items'           => array(
						'type' => 'integer',
					),
					'choices'         => cnvsport_get_categories_stack(),
					'active_callback' => array(
						array(
							'field'    => 'source',
							'operator' => '==',
							'value'    => 'categories',
						),
					),
				),
				array(
					'key'             => 'categories_orderby',
					'label'           => esc_html__( 'Order By', 'canvas-portfolio' ),
					'section'         => 'query',
					'type'            => 'select',
					'multiple'        => false,
					'choices'         => array(
						'name'    => esc_html__( 'Name', 'canvas-portfolio' ),
						'count'   => esc_html__( 'Posts count', 'canvas-portfolio' ),
						'include' => esc_html__( 'Filter include', 'canvas-portfolio' ),
						'id'      => esc_html__( 'ID', 'canvas-portfolio' ),
					),
					'default'         => 'name',
					'active_callback' => array(
						array(
							'field'    => 'source',
							'operator' => '==',
							'value'    => 'categories',
						),
					),
				),
				array(
					'key'             => 'categories_order',
					'label'           => esc_html__( 'Order', 'canvas-portfolio' ),
					'section'         => 'query',
					'type'            => 'select',
					'multiple'        => false,
					'choices'         => array(
						'ASC'  => esc_html__( 'ASC', 'canvas-portfolio' ),
						'DESC' => esc_html__( 'DESC', 'canvas-portfolio' ),
					),
					'default'         => 'ASC',
					'active_callback' => array(
						array(
							'field'    => 'source',
							'operator' => '==',
							'value'    => 'categories',
						),
					),
				),
				// Type Projects.
				array(
					'key'             => 'video',
					'label'           => esc_html__( 'Video Background', 'canvas-portfolio' ),
					'section'         => 'general',
					'type'            => 'select',
					'choices'         => array(
						'none'   => esc_html__( 'None', 'canvas-portfolio' ),
						'always' => esc_html__( 'Always', 'canvas-portfolio' ),
						'hover'  => esc_html__( 'On Hover', 'canvas-portfolio' ),
					),
					'default'         => 'always',
					'active_callback' => array(
						array(
							'field'    => 'source',
							'operator' => '==',
							'value'    => 'projects',
						),
					),
				),
				array(
					'key'             => 'video_contrlos',
					'label'           => esc_html__( 'Enable video contrlos', 'canvas-portfolio' ),
					'section'         => 'general',
					'type'            => 'toggle',
					'default'         => true,
					'active_callback' => array(
						array(
							'field'    => 'source',
							'operator' => '==',
							'value'    => 'projects',
						),
						array(
							'field'    => 'video',
							'operator' => '!=',
							'value'    => 'none',
						),
					),
				),
				// Type Post.
				array(
					'key'             => 'custom_post',
					'label'           => esc_html__( 'Post', 'canvas-portfolio' ),
					'section'         => 'general',
					'type'            => 'posts-selector',
					'active_callback' => array(
						array(
							'field'    => 'source',
							'operator' => '==',
							'value'    => 'post',
						),
					),
				),
				// Type Custom.
				array(
					'key'             => 'custom_images',
					'label'           => esc_html__( 'Images', 'canvas-portfolio' ),
					'type'            => 'gallery',
					'section'         => 'general',
					'items'           => array(
						'type' => 'integer',
					),
					'active_callback' => array(
						array(
							'field'    => 'source',
							'operator' => '==',
							'value'    => 'custom',
						),
					),
				),

				// Common end.
				array(
					'key'     => 'number_items',
					'label'   => esc_html__( 'Number of Items', 'canvas-portfolio' ),
					'section' => 'general',
					'type'    => 'number',
					'default' => 10,
					'min'     => 1,
					'max'     => 100,
				),
			),
			'template'      => dirname( __FILE__ ) . '/block/post-area-init.php',
			'style'         => 'canvas-portfolio-block-style',
			'script'        => 'canvas-portfolio-block-script',
			'editor_style'  => 'canvas-portfolio-block-style',
			'editor_script' => 'canvas-portfolio-block-script',
		);

		return $blocks;
	}
}

new CNVSPort_Block();
